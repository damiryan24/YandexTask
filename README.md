# YandexTask
Решение тестового задания на позицию стажера в группу дежурных инженеров SOC 2025

### Процесс анализа:
- Для анализа предоставленных логов я воспользовался программой Log Parser Studio
- Сначала с помощью sql запроса в processes_running_processes.csv я нашёл все строки где в cmdline было бы что-то связанное с консолью(SELECT * FROM ..\processes_running_processes.csv WHERE cmdline LIKE '%conhost.exe%' OR cmdline LIKE '%cmd.exe%' OR cmdline LIKE '%powershell.exe%' OR cmdline LIKE '%pwsh.exe%')
- В получившейся таблице выбрал столбец pid, сохранил как отдельный файл
- С помощью скрипта на python (dec_to_hex.py, есть в репозитории) из столбца с прошлого шага создал таблицу с двумя столбцами pid, в десятичном и шестнадцатеричном формате
- Отфильтровал процессы с получившимся pid в win_events_process_audit.csv (SELECT * FROM ..\win_events_process_audit.csv WHERE pid IN (SELECT hex_pid FROM ..\hex_pid_table.CSV), использовал такой способ т.к. Log Parser не поддерживает JOIN)
- Пока я проверял, устанавливал ли какой-то из этих процессов сетевые подключения, я наткнулся на подозрительный родительский файл "C:\Users\johndoe\Downloads\Invoice\Invoice\Invoice.pdf.exe" (исполняемый файл, маскирующийся под документ)
- Этот файл выполнил в консоли следующую команду: "\??\C:\Windows\system32\conhost.exe 0xffffffff -ForceV1", эта команда принудительно запускает Console Host версии 1 вместо более современной версии 2, приводя систему в уязвимое состояние; вместе сподозрительным расширением это явно указывает на вредоносность файла, это даёт ответ на первый вопрос
- Зная имя вредоносного процесса и отфильтровав по нему network_extra_process_connections.csv, я нашёл IP-адрес C&C-сервера злоумышленника: 212.118.39.217, это ответ на третий вопрос
- После этого я стал анализировать последний оставшийся файл - win_events_powershell_logs.csv
- Отфильтровав записи по времени и просматривая скрипты PowerShell (логи скриптов как раз совпадают по времени с вредоносным процессом) я восстановил ход атаки:
1) Сначала были выполнены диагностические скрипты для анализа окружения
2) Затем был импортирован PowerSploit и созданы кастомные функций для работы с Defender
3) Затем отключение AMSI и модификация настроек Defender
4) Инъекция DLL и кража данных из буфера обмена, папки Protect и сертификата, выпущенного "YandexInternalCA"
- Таким образом в качестве инструментов злоумышленник использовал фреймворк PowerSploit (является легитимным инструментом для пентеста, но его компоненты могут использоватся злоумышленниками), DLL-инъекцию, кастомные функции Start-MpRollback и Get-MpComputerStatus для управления Defender, стандартные командлеты PowerShell: Set-MpPreference - для изменения настроек Defender, Get-Clipboard - для кражи данных из буфера обмена, Get-ChildItem - для исследования файловой системы, а также обфусцированный код для обхода AMSI через модификацию внутреннего поля .NET; это ответы на второй, четвёртый и пятый вопросы

### Итоговые ответы:
1) Вредоносный файл называется Invoice.pdf.exe, скорее всего был прислан по почте или в месседжере под видом pdf-документа
2) Злоумышленник Запустил более старую версию console host, использовал фреймворк PowerSploit и DLL-инъекцию, а также различные командлеты PowerShell. Всё это использовалось для кражи данных (из буфера обмена, из папки Protect в которой хранятся пароли) и кражи сертификата, выпущенного "YandexInternalCA"
3) IP-адрес C&C-сервера злоумышленника: 212.118.39.217
4) Сначала злоумышленник использовал Start-MpRollback для отката компонентов Defender, затем Set-MpPreference -DisableRealtimeMonitoring $true для отклюения мониторинга в реальном времени, также злоумышленник выполнял вредоносный скрипт из доверенных путей C:\Windows\CCM\SystemTemp
5) С помощью глубокой обфускации выполнился код, который патчит AMSI.dll в памяти для недопущения проверки входящих скриптов антивирусным средством
